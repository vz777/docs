"use strict";(self.webpackChunkthelia=self.webpackChunkthelia||[]).push([[5732],{3905:(e,n,t)=>{t.d(n,{Zo:()=>c,kt:()=>m});var r=t(7294);function a(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function l(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?l(Object(t),!0).forEach((function(n){a(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):l(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,r,a=function(e,n){if(null==e)return{};var t,r,a={},l=Object.keys(e);for(r=0;r<l.length;r++)t=l[r],n.indexOf(t)>=0||(a[t]=e[t]);return a}(e,n);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(r=0;r<l.length;r++)t=l[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(a[t]=e[t])}return a}var s=r.createContext({}),u=function(e){var n=r.useContext(s),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},c=function(e){var n=u(e.components);return r.createElement(s.Provider,{value:n},e.children)},d={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},p=r.forwardRef((function(e,n){var t=e.components,a=e.mdxType,l=e.originalType,s=e.parentName,c=i(e,["components","mdxType","originalType","parentName"]),p=u(t),m=a,f=p["".concat(s,".").concat(m)]||p[m]||d[m]||l;return t?r.createElement(f,o(o({ref:n},c),{},{components:t})):r.createElement(f,o({ref:n},c))}));function m(e,n){var t=arguments,a=n&&n.mdxType;if("string"==typeof e||a){var l=t.length,o=new Array(l);o[0]=p;var i={};for(var s in n)hasOwnProperty.call(n,s)&&(i[s]=n[s]);i.originalType=e,i.mdxType="string"==typeof e?e:a,o[1]=i;for(var u=2;u<l;u++)o[u]=t[u];return r.createElement.apply(null,o)}return r.createElement.apply(null,t)}p.displayName="MDXCreateElement"},7845:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>s,contentTitle:()=>o,default:()=>d,frontMatter:()=>l,metadata:()=>i,toc:()=>u});var r=t(7462),a=(t(7294),t(3905));const l={title:"Propel",sidebar_position:4},o=void 0,i={unversionedId:"propel",id:"propel",title:"Propel",description:"Thelia utilise l'orm Propel 2 pour interagir avec la base de donn\xe9es.",source:"@site/docs/propel.md",sourceDirName:".",slug:"/propel",permalink:"/docs/docs/propel",draft:!1,editUrl:"https://github.com/vz777/docs/edit/main/docs/propel.md",tags:[],version:"current",sidebarPosition:4,frontMatter:{title:"Propel",sidebar_position:4},sidebar:"myAutogeneratedSidebar",previous:{title:"Enrichir Thelia",permalink:"/docs/docs/extending_thelia"},next:{title:"Template",permalink:"/docs/docs/template"}},s={},u=[{value:"D\xe9crire le schema",id:"d\xe9crire-le-schema",level:2},{value:"G\xe9nerer Sql / Model \xe0 partir du schema",id:"g\xe9nerer-sql--model-\xe0-partir-du-schema",level:2},{value:"Executer Sql",id:"executer-sql",level:2},{value:"A l&#39;initialization du module",id:"a-linitialization-du-module",level:3},{value:"A la mise \xe0 jour du module",id:"a-la-mise-\xe0-jour-du-module",level:3},{value:"Ajouter une colonne \xe0 la table native de Thelia",id:"ajouter-une-colonne-\xe0-la-table-native-de-thelia",level:2}],c={toc:u};function d(e){let{components:n,...t}=e;return(0,a.kt)("wrapper",(0,r.Z)({},c,t,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("p",null,"Thelia utilise l'orm ",(0,a.kt)("a",{parentName:"p",href:"http://propelorm.org/"},"Propel 2")," pour interagir avec la base de donn\xe9es."),(0,a.kt)("h2",{id:"d\xe9crire-le-schema"},"D\xe9crire le schema"),(0,a.kt)("p",null,"Pour ajouter une nouvelle table dans Thelia, vous devez la d\xe9crire dans votre sch\xe9ma qui se trouve ici ",(0,a.kt)("inlineCode",{parentName:"p"},"MyModule/Config/schema.xml")," veuillez regarder la ",(0,a.kt)("a",{parentName:"p",href:"http://propelorm.org/documentation/reference/schema.html"},"documentation de propel")," pour savoir comment faire."),(0,a.kt)("h2",{id:"g\xe9nerer-sql--model-\xe0-partir-du-schema"},"G\xe9nerer Sql / Model \xe0 partir du schema"),(0,a.kt)("p",null,"Pour g\xe9n\xe9rer une requ\xeate SQL et la classe de mod\xe8le associ\xe9e \xe0 partir du sch\xe9ma, utilisez la commande suivante"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-bash"},"php Thelia module:generate:model --generate-sql MyProject\n")),(0,a.kt)("p",null,"Cette commande va g\xe9n\xe9rer un fichier TheliaMain.sql dans ",(0,a.kt)("inlineCode",{parentName:"p"},"local/modules/MyProject/Confif/TheliaMain.sql")," ne le modifiez pas, il sera \xe9crs\xe9 \xe0 chaque fois que la commande sera \xe9xecut\xe9e.\nCela va aussi g\xe9n\xe9rer les fichiers ",(0,a.kt)("a",{parentName:"p",href:"http://propelorm.org/documentation/reference/active-record.html"},"Model")," et ",(0,a.kt)("a",{parentName:"p",href:"http://propelorm.org/documentation/reference/model-criteria.html"},"ModelQuery")," pour chaque table,  dans ces fichiers, vous pouvez ajouter vos propres fonctions ou propri\xe9t\xe9s, elles ne seront pas effac\xe9es car ce ne sont que des classes vides qui \xe9tendent le v\xe9ritable mod\xe8le Propel situ\xe9 dans le cache Propel."),(0,a.kt)("h2",{id:"executer-sql"},"Executer Sql"),(0,a.kt)("h3",{id:"a-linitialization-du-module"},"A l'initialization du module"),(0,a.kt)("p",null,"Si vous voulez \xe9xecuter le sql \xe0 la premi\xe8re activation du module, ajouter cette m\xe9thode dans le fichier php \xe0 la racine du module"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-php"},"    public function postActivation(ConnectionInterface $con = null): void\n    {\n        // Look if module has already been activated\n        if (!self::getConfigValue('is_initialized', false)) {\n            $database = new Database($con);\n            // Insert generated file\n            $database->insertSql(null, [__DIR__.'/Config/TheliaMain.sql']);\n\n            // Set module as initialized\n            self::setConfigValue('is_initialized', true);\n        }\n    }\n")),(0,a.kt)("h3",{id:"a-la-mise-\xe0-jour-du-module"},"A la mise \xe0 jour du module"),(0,a.kt)("p",null,"Si votre module a d\xe9j\xe0 \xe9t\xe9 activ\xe9, vous devez passer par le syst\xe8me de mise \xe0 jour.\nPour l'instant il n'y a pas de moyen d'obtenir directement la requ\xeate sql n\xe9cessaire \xe0 la mise \xe0 jour de votre base de donn\xe9es, vous devez l'extraire du fichier TheliaMain.sql g\xe9n\xe9r\xe9."),(0,a.kt)("p",null,"Par exemple, si lors de l'initialisation du module vous avez g\xe9n\xe9r\xe9 ce sql :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"DROP TABLE IF EXISTS `block_group`;\n\nCREATE TABLE `block_group`\n(\n    `id` INTEGER NOT NULL AUTO_INCREMENT,\n    `slug` VARCHAR(50),\n    `created_at` DATETIME,\n    `updated_at` DATETIME,\n    PRIMARY KEY (`id`),\n    UNIQUE INDEX `slug_unique` (`slug`)\n) ENGINE=InnoDB;\n")),(0,a.kt)("p",null,'Et plus tard, vous voulez ajouter une nouvelle colonne bool\xe9enne nomm\xe9e "visible" \xe0 votre table, vous l\'ajouterez \xe0 votre shema.xml et vous obtiendrez ce code SQL :'),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"DROP TABLE IF EXISTS `block_group`;\n\nCREATE TABLE `block_group`\n(\n    `id` INTEGER NOT NULL AUTO_INCREMENT,\n    `slug` VARCHAR(50),\n    `visible` TINYINT DEFAULT 0 NOT NULL,\n    `created_at` DATETIME,\n    `updated_at` DATETIME,\n    PRIMARY KEY (`id`),\n    UNIQUE INDEX `slug_unique` (`slug`)\n) ENGINE=InnoDB;\n")),(0,a.kt)("p",null,"Il faut donc extraire uniquement la diff\xe9rence comme suit"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-sql"},"ALTER TABLE `block_group` ADD `visible` TINYINT DEFAULT 0 NOT NULL;\n")),(0,a.kt)("p",null,"Puis mettez ces requ\xeates extraites dans un nouveau fichier situ\xe9 ici ",(0,a.kt)("inlineCode",{parentName:"p"},"local/modules/MyProject/Config/update/")," le nom du fichier doit \xeatre la prochaine version de votre module. Par exemple, si la version de votre module est ",(0,a.kt)("inlineCode",{parentName:"p"},"1.0.6")," et que la prochaine version est ",(0,a.kt)("inlineCode",{parentName:"p"},"1.1.0"),", cr\xe9ez ce fichier ",(0,a.kt)("inlineCode",{parentName:"p"},"local/modules/MyProject/Config/update/1.1.0.sql")," et mettez-y le sql et changez le ",(0,a.kt)("inlineCode",{parentName:"p"},"<version></version>")," dans module.xml.\nAssurez-vous que vous avez cette m\xe9thode dans votre fichier de base :"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-php"},"    /**\n     * Execute sql files in Config/update/ folder named with module version (ex: 1.0.1.sql).\n     *\n     * @param $currentVersion\n     * @param $newVersion\n     * @param ConnectionInterface $con\n     */\n    public function update($currentVersion, $newVersion, ConnectionInterface $con = null): void\n    {\n        $finder = Finder::create()\n            ->name('*.sql')\n            ->depth(0)\n            ->sortByName()\n            ->in(__DIR__.DS.'Config'.DS.'update');\n\n        $database = new Database($con);\n\n        /** @var \\SplFileInfo $file */\n        foreach ($finder as $file) {\n            if (version_compare($currentVersion, $file->getBasename('.sql'), '<')) {\n                $database->insertSql(null, [$file->getPathname()]);\n            }\n        }\n    }\n")),(0,a.kt)("p",null,"Si ce n'est pas le cas, vous devrez l'ajouter.\nCette fonction est appel\xe9e lorsque Thelia rafra\xeechit la liste des modules (soit dans la page d'administration, soit par commande) et d\xe9tecte que la prochaine version de votre module est diff\xe9rente de la version actuelle.\nElle recherchera et ex\xe9cutera tous les fichiers sql entre les deux versions."),(0,a.kt)("h2",{id:"ajouter-une-colonne-\xe0-la-table-native-de-thelia"},"Ajouter une colonne \xe0 la table native de Thelia"),(0,a.kt)("p",null,"Dans Thelia, il n'est ",(0,a.kt)("strong",{parentName:"p"},"pas")," possible de modifier les tables natives.\nLa meilleure pratique pour ajouter des colonnes est de cr\xe9er une nouvelle table avec une cl\xe9 \xe9trang\xe8re attach\xe9e \xe0 la table de base."),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-xml"},'    <table name="extend_customer_data" namespace="MyProject\\Model">\n        <column name="id" primaryKey="true" required="true" type="INTEGER" />\n        <column name="additional_column" type="VARCHAR" size="255" />\n        <foreign-key foreignTable="customer" name="fk_extend_customer_data_customer_id" onDelete="CASCADE" onUpdate="CASCADE">\n            <reference foreign="id" local="id" />\n        </foreign-key>\n        ...\n    </table>\n')))}d.isMDXComponent=!0}}]);